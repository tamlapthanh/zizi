<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matching Game</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/konva@8.3.5/konva.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      overflow: hidden;
    }
    #container {
      width: 100vw;
      height: 100vh;
      border: 1px solid black;
      position: relative;
    }
    .modal-content {
      text-align: center;
    }
    .modal-header, .modal-body, .modal-footer {
      border: none;
    }
    .modal-body select {
      margin: 10px 0;
    }
    .modal-footer button {
      margin: 0 5px;
    }
  </style>
</head>
<body>
  <div id="container"></div>
  
  <!-- Modal -->
  <div class="modal fade" id="vocabModal" tabindex="-1" role="dialog" aria-labelledby="vocabModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="vocabModalLabel">Chọn bộ từ vựng</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <select id="vocabSelect" class="form-control">
            <option value="animals">Tên con vật</option>
            <option value="householdItems">Vật dụng trong nhà</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="startButton">Chơi thôi, bệnh gì cữ</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Bỏ đi 8</button>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    let stage, layer;
    let words = [];
    let meanings = [];
    let correctMatches = {};
    let selectedWord = null;
    let texts = [];

    const vocab = {
      animals: [
        { word: 'Dog', meaning: 'Con chó', lang: 'en' },
        { word: 'Cat', meaning: 'Con mèo', lang: 'en' },
        { word: 'Bird', meaning: 'Con chim', lang: 'en' },
        { word: 'Fish', meaning: 'Con cá', lang: 'en' },
        { word: 'Horse', meaning: 'Con ngựa', lang: 'en' },
        { word: 'Cow', meaning: 'Con bò', lang: 'en' },
        { word: 'Sheep', meaning: 'Con cừu', lang: 'en' },
        { word: 'Duck', meaning: 'Con vịt', lang: 'en' },
        { word: 'Goat', meaning: 'Con dê', lang: 'en' },
        { word: 'Pig', meaning: 'Con lợn', lang: 'en' },
        { word: 'Elephant', meaning: 'Con voi', lang: 'en' },
        { word: 'Lion', meaning: 'Sư tử', lang: 'en' },
        { word: 'Tiger', meaning: 'Hổ', lang: 'en' },
        { word: 'Bear', meaning: 'Gấu', lang: 'en' },
        { word: 'Wolf', meaning: 'Sóc', lang: 'en' },
        { word: 'Rabbit', meaning: 'Thỏ', lang: 'en' },
        { word: 'Monkey', meaning: 'Khỉ', lang: 'en' },
        { word: 'Giraffe', meaning: 'Hươu cao cổ', lang: 'en' },
        { word: 'Kangaroo', meaning: 'Kangaroo', lang: 'en' },
        { word: 'Zebra', meaning: 'Ngựa vằn', lang: 'en' },
        { word: 'Penguin', meaning: 'Chim cánh cụt', lang: 'en' }
      ],
      householdItems: [
        { word: 'Table', meaning: 'Bàn', lang: 'en' },
        { word: 'Chair', meaning: 'Ghế', lang: 'en' },
        { word: 'Lamp', meaning: 'Đèn', lang: 'en' },
        { word: 'Sofa', meaning: 'Sofa', lang: 'en' },
        { word: 'Bed', meaning: 'Giường', lang: 'en' },
        { word: 'Refrigerator', meaning: 'Tủ lạnh', lang: 'en' },
        { word: 'Oven', meaning: 'Lò nướng', lang: 'en' },
        { word: 'Microwave', meaning: 'Lò vi sóng', lang: 'en' },
        { word: 'Washing Machine', meaning: 'Máy giặt', lang: 'en' },
        { word: 'Toaster', meaning: 'Máy nướng bánh', lang: 'en' },
        { word: 'Cabinet', meaning: 'Tủ đựng đồ', lang: 'en' },
        { word: 'Shelf', meaning: 'Kệ', lang: 'en' },
        { word: 'Curtain', meaning: 'Rèm cửa', lang: 'en' },
        { word: 'Mirror', meaning: 'Gương', lang: 'en' },
        { word: 'Clock', meaning: 'Đồng hồ', lang: 'en' },
        { word: 'Painting', meaning: 'Tranh', lang: 'en' },
        { word: 'Carpet', meaning: 'Thảm', lang: 'en' },
        { word: 'Pillow', meaning: 'Gối', lang: 'en' },
        { word: 'Blanket', meaning: 'Chăn', lang: 'en' },
        { word: 'Drawer', meaning: 'Ngăn kéo', lang: 'en' }
      ]
    };

    const getFontSize = () => {
      const width = window.innerWidth;
      if (width < 800) {
        return 32; // Larger font size for mobile
      } else {
        return 24; // Default font size
      }
    };

    const getRandomElements = (arr, count) => {
      const shuffled = arr.slice(0);
      let i = shuffled.length, temp, index;
      while (i--) {
        index = Math.floor(Math.random() * (i + 1));
        temp = shuffled[i];
        shuffled[i] = shuffled[index];
        shuffled[index] = temp;
      }
      return shuffled.slice(0, count);
    };

    const getRandomWordsAndMeanings = (vocabCategory) => {
      const vocabList = vocab[vocabCategory];
      const pairs = getRandomElements(vocabList, 5); // Choose 5 pairs
      words = pairs.map(pair => pair.word);
      meanings = pairs.map(pair => pair.meaning);
      correctMatches = {};
      pairs.forEach(pair => {
        correctMatches[pair.word] = pair.meaning;
        correctMatches[pair.meaning] = pair.word; // Add reverse mapping
      });
    };

    const isOverlapping = (pos, size) => {
      const padding = 20;
      return texts.some(txt => {
        const txtPos = txt.getClientRect();
        return !(pos.x + size.width < txtPos.x ||
                 pos.x > txtPos.x + txtPos.width ||
                 pos.y + size.height < txtPos.y ||
                 pos.y > txtPos.y + txtPos.height);
      });
    };

    const getRandomPosition = (size) => {
      let pos;
      do {
        pos = {
          x: Math.random() * (stage.width() - size.width),
          y: Math.random() * (stage.height() - size.height),
        };
      } while (isOverlapping(pos, size));
      return pos;
    };

    const createText = (text, x, y) => {
      const fontSize = getFontSize();

      const txt = new Konva.Text({
        x: x,
        y: y,
        text: text,
        fontSize:  fontSize * (stage.width() / 800), // Responsive font size
        fontFamily: 'Calibri',
        fill: 'black',
        padding: 10,
        align: 'center',
        verticalAlign: 'middle',
        draggable: true,
        isSelected: false
      });

      txt.on('mouseover', () => {
        document.body.style.cursor = 'pointer';
        txt.fill('green');
        layer.draw();
      });

      txt.on('mouseout', () => {
        document.body.style.cursor = 'default';
        if (!txt.isSelected) {
          txt.fill('black');
        }
        layer.draw();
      });

      txt.on('click', () => {
        handleTextClick(txt);
        playTextSound(txt.text());
      });

      txt.on('tap', () => {
        handleTextClick(txt);
        playTextSound(txt.text());
      });

      return txt;
    };

    const createObjects = (vocabCategory) => {
      layer.destroyChildren();
      texts = [];
      getRandomWordsAndMeanings(vocabCategory);

      words.forEach(word => {
        const fontSize = getFontSize();
        const size = { width: 100 * (stage.width() / 800), height: fontSize }; // Responsive size
        const pos = getRandomPosition(size);
        const text = createText(word, pos.x, pos.y);
        texts.push(text);
        layer.add(text);
      });

      meanings.forEach(meaning => {
        const fontSize = getFontSize();
        const size = { width: 100 * (stage.width() / 800), height: fontSize }; // Responsive size
        const pos = getRandomPosition(size);
        const text = createText(meaning, pos.x, pos.y);
        texts.push(text);
        layer.add(text);
      });

      layer.draw();
    };

    const createFireworks = () => {
      const fireworksLayer = new Konva.Layer();
      stage.add(fireworksLayer);

      const fireworks = [];
      for (let i = 0; i < 30; i++) {
        const firework = new Konva.Circle({
          x: Math.random() * stage.width(),
          y: Math.random() * stage.height(),
          radius: Math.random() * 5 + 5,
          fill: `hsl(${Math.random() * 360}, 100%, 50%)`,
          opacity: 1,
        });
        fireworksLayer.add(firework);
        fireworks.push(firework);

        const tween = new Konva.Tween({
          node: firework,
          duration: 1,
          scaleX: 0.5,
          scaleY: 0.5,
          opacity: 0,
          onFinish: () => {
            firework.destroy();
            fireworksLayer.draw();
          }
        });
        tween.play();
      }

      fireworksLayer.draw();

      // Reset the game after the fireworks effect
      setTimeout(() => {
        const selectedCategory = document.getElementById('vocabSelect').value;
        createObjects(selectedCategory); // Reset with the same category
      }, 2000); // Wait for fireworks to finish before resetting
    };

    const playTextSound = (text) => {
      const utterance = new SpeechSynthesisUtterance(text);
      const isVietnamese = vocab.animals.some(pair => pair.meaning === text) || vocab.householdItems.some(pair => pair.meaning === text);
      utterance.lang = isVietnamese ? 'vi-VN' : 'en-US';
      speechSynthesis.speak(utterance);
    };

    const handleTextClick = (text) => {
      if (text.isSelected) return;

      if (selectedWord) {
        const word = selectedWord.text();
        const meaning = text.text();
        if (correctMatches[word] === meaning || correctMatches[meaning] === word) {
          const matchedWord = selectedWord;
          const matchedMeaning = text;

          const tween1 = new Konva.Tween({
            node: matchedWord,
            duration: 0.5,
            scaleX: 0,
            scaleY: 0,
            opacity: 0,
            onFinish: () => {
              matchedWord.destroy();
              texts.splice(texts.indexOf(matchedWord), 1);
            },
          });

          const tween2 = new Konva.Tween({
            node: matchedMeaning,
            duration: 0.5,
            scaleX: 0,
            scaleY: 0,
            opacity: 0,
            onFinish: () => {
              matchedMeaning.destroy();
              texts.splice(texts.indexOf(matchedMeaning), 1);
              if (texts.length === 0) {
                createFireworks(); // Create fireworks effect when the game is completed
              }
            },
          });

          tween1.play();
          tween2.play();
          selectedWord = null;
          layer.draw();
        } else {
          // Remove color of the selected words if they do not match
          selectedWord.fill('black');
          text.fill('black');
          selectedWord.isSelected = false;
          text.isSelected = false;
          selectedWord = null;
          layer.draw();
        }
      } else {
        // Reset the previously selected word if needed
        if (selectedWord) {
          selectedWord.fill('black');
        }

        selectedWord = text;
        selectedWord.fill('red');
        selectedWord.isSelected = true;
      }
      layer.draw();
    };

    const init = () => {
      stage = new Konva.Stage({
        container: 'container',
        width: window.innerWidth,
        height: window.innerHeight,
      });

      layer = new Konva.Layer();
      stage.add(layer);

      window.addEventListener('resize', () => {
        stage.width(window.innerWidth);
        stage.height(window.innerHeight);
        if ($('.modal').hasClass('show') === false) {
          createObjects(document.getElementById('vocabSelect').value); // Initialize with selected category
        }
      });

      $('#startButton').on('click', () => {
        const selectedCategory = document.getElementById('vocabSelect').value;
        createObjects(selectedCategory);
        $('#vocabModal').modal('hide'); // Close modal
      });

      $('#vocabModal').modal('show'); // Show modal on page load
    };

    init();
  </script>
</body>
</html>
